#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2023 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#

ARCH="arm64"

LINUXFAMILY="qrb2210"
enable_extension "image-output-arduino"
declare -g IMAGE_PARTITION_TABLE='gpt'
declare -g ATF_COMPILE="no"

declare -g BOOTDELAY=1
declare -g BOOTSOURCE='https://github.com/arduino/u-boot.git'
declare -g BOOTPATCHDIR="${BOOTPATCHDIR:-"u-boot-qrb2210"}"
declare -g BOOTBRANCH="${BOOTBRANCH:-"branch:qcom-mainline"}"
declare -g UBOOT_TARGET_MAP="DEVICE_TREE=${BOOT_FDT_FILE:0:-4};;u-boot.bin boot.img"
declare -g EXTRAWIFI=no
declare -g KERNEL_BTF=no

# This build requires xxd
function add_host_dependencies__qrb2210_add_xxd_hostdep() {
	display_alert "Adding xxd dep" "for ${BOARD} bootloader compile" "debug"
	declare -g EXTRA_BUILD_DEPS="${EXTRA_BUILD_DEPS} xxd"
}

# Handling of aboot
# https://github.com/arduino/arduino-deb-images/blob/arduino/scripts/build-u-boot-rb1.sh
function uboot_custom_postprocess() {
	run_host_command_logged cd "$SRC"/cache/sources/u-boot-worktree/u-boot/qcom-mainline
	run_host_command_logged rm -f u-boot-nodtb.bin.gz u-boot-nodtb.bin.gz-dtb empty-ramdisk boot.img mkbootimg
	run_host_command_logged gzip u-boot-nodtb.bin
	run_host_command_logged cat u-boot-nodtb.bin.gz \
    						"dts/upstream/src/arm64/${BOOT_FDT_FILE}" \
    						>u-boot-nodtb.bin.gz-dtb
    						
    run_host_command_logged touch empty-ramdisk
    
    # https://bugs.launchpad.net/ubuntu/+source/android-platform-tools/+bug/2058228
    # https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1050300
    run_host_command_logged wget https://launchpadlibrarian.net/810765814/mkbootimg
    run_host_command_logged chmod +x mkbootimg

	run_host_command_logged ./mkbootimg --base "0x80000000" \
    						--pagesize "4096" \
    						--kernel u-boot-nodtb.bin.gz-dtb  \
    						--cmdline "root=/dev/notreal" \
    						--ramdisk empty-ramdisk \
    						--output "boot.img"
}

case "${BRANCH}" in

	edge)
		KERNELSOURCE='https://github.com/arduino/linux-qcom.git'
		KERNELBRANCH="branch:qcom-v6.16.7-unoq"
		declare -g KERNEL_MAJOR_MINOR="6.16"
		KERNELPATCHDIR="${LINUXFAMILY}-${BRANCH}"
		LINUXCONFIG="linux-${LINUXFAMILY}-${BRANCH}"

		;;

esac

write_uboot_platform() {
	display_alert "Skip."
}
